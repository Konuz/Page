RewriteEngine On

# Enforce HTTPS (only on canonical hosts)
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} ^(?:www\.)?toolshare\.com\.pl$ [NC]
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Enforce non-www (match canonical in HTML: toolshare.com.pl)
RewriteCond %{HTTP_HOST} ^www\.toolshare\.com\.pl$ [NC]
RewriteRule ^ https://toolshare.com.pl%{REQUEST_URI} [R=301,L]

# Canonical redirects to pretty URLs
# /index.html -> /
RewriteCond %{THE_REQUEST} \s/+index\.html\s [NC]
RewriteRule ^index\.html$ / [R=301,L,NE]

# Add trailing slash for real directories requested without slash
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^(.+[^/])$ /$1/ [R=301,L]

# Avoid 403 on physical dir by redirecting section root to a landing category
RewriteRule ^narzedzia/?$ /narzedzia/elektronarzedzia/ [R=301,L]

# 301 from .html query to slug paths
# /category.html?category=Kategoria -> /narzedzia/slug(kategoria)
RewriteCond %{THE_REQUEST} \s/+category\.html [NC]
RewriteCond %{QUERY_STRING} (?:^|&)category=([^&]+) [NC]
RewriteRule ^category\.html$ /narzedzia/%1 [R=301,L,NE,QSD]

# /subcategory.html?category=Kategoria&subcategory=Podkategoria -> /narzedzia/slug(kategoria)/slug(podkategoria)
RewriteCond %{THE_REQUEST} \s/+subcategory\.html [NC]
RewriteCond %{QUERY_STRING} (?:^|&)category=([^&]+) [NC]
RewriteCond %{QUERY_STRING} (?:^|&)subcategory=([^&]+) [NC]
RewriteRule ^subcategory\.html$ /narzedzia/%1/%2 [R=301,L,NE,QSD]

# 1) Serve existing files/directories as-is
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# 2) Home
RewriteRule ^$ index.html [L]

# 3) Pretty URLs → real pages with query params
# Normalize to trailing slash for virtual /narzedzia paths (non-physical)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^narzedzia/(.+[^/])$ /narzedzia/$1/ [R=301,L]

# /narzedzia/kategoria → category.html
RewriteRule ^narzedzia/([^/]+)/?$ category.html?category=$1 [QSA,B,L]
# /narzedzia/kategoria/podkategoria → subcategory.html
RewriteRule ^narzedzia/([^/]+)/([^/]+)/?$ subcategory.html?category=$1&subcategory=$2 [QSA,B,L]
# /narzedzia/kategoria/podkategoria/narzedzie → tool.html
RewriteRule ^narzedzia/([^/]+)/([^/]+)/([^/]+)/?$ tool.html?toolId=$3 [QSA,B,L]

# Normalize mislinked legal/about pages nested under category paths
RewriteRule ^narzedzia/.*/(o-nas|polityka-prywatnosci|regulamin)\.html$ /$1.html [R=301,L]
